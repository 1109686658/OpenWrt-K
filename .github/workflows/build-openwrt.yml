#MIT License

#Copyright (c) 2023 沉默の金

#Permission is hereby granted, free of charge, to any person obtaining a copy
#of this software and associated documentation files (the "Software"), to deal
#in the Software without restriction, including without limitation the rights
#to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
#copies of the Software, and to permit persons to whom the Software is
#furnished to do so, subject to the following conditions:

#The above copyright notice and this permission notice shall be included in all
#copies or substantial portions of the Software.

#THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
#AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
#LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
#OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
#SOFTWARE.

name: Build OpenWrt-K
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:


          
      - name: 建立工作文件夹
        run:  |
          cd $GITHUB_WORKSPACE
          sudo mkdir -p workspace
          sudo chown $USER:$GROUPS workspace
          cd workspace
          export WORKSPACE_ROOT_PATH="$(pwd)"
          echo "WORKSPACE_ROOT_PATH=$WORKSPACE_ROOT_PATH" >> $GITHUB_ENV
          mkdir -p package
          cd package
          export PACKAGE_ROOT_PATH="$(pwd)"
          echo "PACKAGE_ROOT_PATH=$PACKAGE_ROOT_PATH" >> $GITHUB_ENV
          mkdir -p chen
          mkdir -p cmzj_package
          
          
      - name: 下载源代码
        working-directory:  ${{ env.WORKSPACE_ROOT_PATH }}
        run: |
          git clone https://git.openwrt.org/openwrt/openwrt.git
          cd openwrt
          export OPENWRT_ROOT_PATH="$(pwd)"
          echo "OPENWRT_ROOT_PATH=$OPENWRT_ROOT_PATH" >> $GITHUB_ENV
          cd $PACKAGE_ROOT_PATH
          mkdir -p chen
          mkdir -p cmzj_package
          cd chen
          git clone https://github.com/Lienol/openwrt-package
          git clone https://github.com/immortalwrt/luci
          git clone https://github.com/xiaorouji/openwrt-passwall -b luci
          git clone https://github.com/wongsyrone/lede-1
          git clone https://github.com/coolsnowwolf/lede
          git clone https://github.com/chenmozhijin/turboacc -b package
          cd lede
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cd ..
          cd ..
          cd cmzj_package
          mkdir -p turboacc
          git clone https://github.com/rufengsuixing/luci-app-adguardhome
          git clone https://github.com/jerrykuku/luci-app-argon-config
          git clone https://github.com/csrutil/OpenWrt-NIC-Drivers
          git clone https://github.com/lisaac/luci-app-diskman
          git clone https://github.com/sirpdboy/luci-app-netdata
          git clone https://github.com/sirpdboy/NetSpeedTest
          git clone https://github.com/xiaorouji/openwrt-passwall
          #git clone https://github.com/xiaorouji/openwrt-passwall2
          git clone https://github.com/davidtall/openwrt-passwall2
          git clone https://github.com/tty228/luci-app-serverchan
          git clone https://github.com/jerrykuku/luci-theme-argon
          cd turboacc
          git clone https://github.com/fullcone-nat-nftables/nft-fullcone
          git clone https://github.com/chenmozhijin/turboacc
          mv ./turboacc/luci-app-turboacc ./
          rm -rf ./turboacc
          
      - name: 复制源代码修复中文支持与Makefile文件
        working-directory: ${{ env.PACKAGE_ROOT_PATH }}
        run: |
          cp -r ./chen/luci/applications/luci-app-transmission ./cmzj_package/
          cp -r ./chen/openwrt-package/luci-app-fileassistant ./cmzj_package/
          cp -r ./chen/openwrt-package/luci-app-socat ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-baidupcs-web ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-rclone ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-syncdial ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-usb-printer ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-qbittorrent ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-vlmcsd ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/net/vlmcsd ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/net/baidupcs-web ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/net/qBittorrent ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/net/qBittorrent-static ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/libs/rblibtorrent ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/libs/qtbase ./cmzj_package/
          cp -r ./chen/lede/feeds/packages/libs/qttools ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-zerotier ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-webadmin ./cmzj_package/
          cp -r ./chen/lede/feeds/luci/applications/luci-app-cifs-mount ./cmzj_package/
          cp -r ./chen/lede/package/lean/ipv6-helper ./cmzj_package/
          cp -r ./chen/lede/package/lean/ddns-scripts_aliyun ./cmzj_package/
          cp -r ./chen/lede/package/lean/ddns-scripts_dnspod ./cmzj_package/
          cp -r ./chen/lede/package/lean/r8168 ./cmzj_package/
          cp -r ./chen/lede/package/lean/shortcut-fe ./cmzj_package/turboacc/
          cp -r ./chen/openwrt-passwall/luci-app-passwall  ./cmzj_package/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/luci-app-webadmin/po/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/luci-app-netdata/po/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/luci-app-vlmcsd/po/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/NetSpeedTest/luci-app-netspeedtest/po/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/luci-app-zerotier/po/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/luci-app-usb-printer/po/
          cp -r ./cmzj_package/luci-app-argon-config/po/zh_Hans ./cmzj_package/luci-app-qbittorrent/po/
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/turboacc/luci-app-turboacc/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-vlmcsd/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-webadmin/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-zerotier/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-cifs-mount/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-baidupcs-web/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-rclone/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-syncdial/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-usb-printer/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-transmission/Makefile
          sed -i 's/include ..\/..\/luci.mk/include $(TOPDIR)\/feeds\/luci\/luci.mk/' ./cmzj_package/luci-app-qbittorrent/Makefile
          sed -i 's/setting")/netdata")/' ./cmzj_package/luci-app-netdata/luasrc/controller/netdata.lua
          sed -i 's/("Base Setting"), 20/("Base Setting"), 30/' ./cmzj_package/luci-app-netdata/luasrc/controller/netdata.lua
          sed -i 's/("NetData"), 30/("NetData"), 20/' ./cmzj_package/luci-app-netdata/luasrc/controller/netdata.lua
          
      - name: 切换到新的稳定版分支
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: git checkout v22.03.3

       - name: 复制cmzj_package 打补丁 
        working-directory: ${{ env.WORKSPACE_ROOT_PATH }}
        run: |
          cp -r ./package/cmzj_package ./openwrt/package/cmzj_package
          cp ./package/chen/lede/target/linux/generic/hack-5.10/952-net-conntrack-events-support-multiple-registrant.patch ./openwrt/target/linux/generic/hack-5.10
          cp ./package/chen/lede/target/linux/generic/hack-5.10/953-net-patch-linux-kernel-to-support-shortcut-fe.patch ./openwrt/target/linux/generic/hack-5.10
          cp ./package/chen/lede/target/linux/generic/hack-5.10/982-add-bcm-fullconenat-support.patch ./openwrt/target/linux/generic/hack-5.10
          mkdir -p ./openwrt/package/network/config/firewall4/patches/
          mkdir -p ./openwrt/package/libs/libnftnl/patches/
          mkdir -p ./openwrt/package/network/utils/nftables/patches/
          cp -r ./package/chen/turboacc/firewall4-7ae5e14bbd7265cc67ec870c3bb0c8e197bb7ca9/firewall4/patches/* ./openwrt/package/network/config/firewall4/patches
          cp -r ./package/chen/turboacc/libs-1.2.1/libnftnl/patches/* ./openwrt/package/libs/libnftnl/patches
          cp -r ./package/chen/turboacc/nftables-1.0.2/nftables/patches/* ./openwrt/package/network/utils/nftables/patches
          sed -i '/PKG_FIXUP:=autoreconf/'d ./openwrt/package/libs/libnftnl/Makefile
          sed -i '/^PKG_INSTALL:/i\PKG_FIXUP:=autoreconf' ./openwrt/package/libs/libnftnl/Makefile
          echo "libnftnl-Makefile"
          cat ./openwrt/package/libs/libnftnl/Makefile
          echo "firewall4-patches"
          cd ./openwrt/package/network/config/firewall4/patches
          ls
          echo "libnftnl-patches"
          cd $OPENWRT_ROOT_PATH/package/libs/libnftnl/patches/
          ls
          echo "nftables-patches"
          cd $OPENWRT_ROOT_PATH/package/network/utils/nftables/patches/
          ls
          echo "hack-5.10" 
          cd $OPENWRT_ROOT_PATH/target/linux/generic/hack-5.10
          ls
          cd $WORKSPACE_ROOT_PATH
          #rm -rf ./package
          sed -i '$a CONFIG_SHORTCUT_FE=y' ./openwrt/target/linux/generic/config-5.10
          sed -i '$a # CONFIG_MERAKI_MX100 is not set' ./openwrt/target/linux/generic/config-5.10 

      - name: 修复问题
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          sed -i 's/-full//' ./include/target.mk 
          sed -i 's/dnsmasq/dnsmasq-full/g' ./include/target.mk 
          sed -i 's/256/1024/' ./target/linux/x86/image/Makefile                
      
      - name: 更新 feeds 
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 更新smartdns
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          WORKINGDIR="`pwd`/feeds/packages/net/smartdns"
          mkdir $WORKINGDIR -p
          rm $WORKINGDIR/* -fr
          wget https://github.com/pymumu/openwrt-smartdns/archive/master.zip -O $WORKINGDIR/master.zip
          unzip $WORKINGDIR/master.zip -d $WORKINGDIR
          mv $WORKINGDIR/openwrt-smartdns-master/* $WORKINGDIR/
          rmdir $WORKINGDIR/openwrt-smartdns-master
          rm $WORKINGDIR/master.zip
          LUCIBRANCH="master" #更换此变量
          WORKINGDIR="`pwd`/feeds/luci/applications/luci-app-smartdns"
          mkdir $WORKINGDIR -p
          rm $WORKINGDIR/* -fr
          wget https://github.com/pymumu/luci-app-smartdns/archive/${LUCIBRANCH}.zip -O $WORKINGDIR/${LUCIBRANCH}.zip
          unzip $WORKINGDIR/${LUCIBRANCH}.zip -d $WORKINGDIR
          mv $WORKINGDIR/luci-app-smartdns-${LUCIBRANCH}/* $WORKINGDIR/
          rmdir $WORKINGDIR/luci-app-smartdns-${LUCIBRANCH}
          rm $WORKINGDIR/${LUCIBRANCH}.zip
      
      - name: 安装 feeds 
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: ./scripts/feeds install -a
      
      - name: 复制自定义文件并加载自定义配置
        run: |
          cp -r files $OPENWRT_ROOT_PATH/files
          chmod 755 $OPENWRT_ROOT_PATH/files/usr/bin/AdGuardHome/AdGuardHome
          chmod 755 $OPENWRT_ROOT_PATH/files/etc/uci-defaults/99_chenmozhijin
          cat ./config/target.config >> $OPENWRT_ROOT_PATH/.config
          cat ./config/luci.config >> $OPENWRT_ROOT_PATH/.config
          cat ./config/utilities.config >> $OPENWRT_ROOT_PATH/.config
          cat ./config/network.config >> $OPENWRT_ROOT_PATH/.config
          cat ./config/other.config >> $OPENWRT_ROOT_PATH/.config
          cat ./config/kmod.config >> $OPENWRT_ROOT_PATH/.config
          cat ./config/image.config >> $OPENWRT_ROOT_PATH/.config
      
      - name: 更新AdGuardHome核心
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          mkdir -p ./files/usr/bin/AdGuardHome/tmp
          rm ./files/usr/bin/AdGuardHome/tmp/* -fr        
          latest_ver="$(curl https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest 2>/dev/null|grep -E 'tag_name' |grep -E 'v[0-9.]+' -o 2>/dev/null)"
          Archt="$(rm -rf Archt && sed -n '/^CONFIG_TARGET_.*=y/p' .config > Archt0 && sed -n '/^CONFIG_TARGET_.*_.*=y/!p' Archt0 > Archt && rm Archt0 && sed -i 's/CONFIG_TARGET_//' Archt && sed -i 's/=y//' Archt && cat Archt)"
          case $Archt in
          "i386")
          Arch="386"
          ;;
          "i686")
          Arch="386"
          ;;
          "x86")
          Arch="amd64"
          ;;
          "mipsel")
          Arch="mipsle"
          ;;
          "mips64el")
          Arch="mips64le"
          Arch="mipsle"
          echo -e "mips64el use $Arch may have bug" 
          ;;
          "mips")
          Arch="mips"
          ;;
          "mips64")
          Arch="mips64"
          Arch="mips"
          echo -e "mips64 use $Arch may have bug" 
          ;;
          "arm")
          Arch="arm"
          ;;
          "aarch64")
          Arch="arm64"
          ;;
          "powerpc")
          Arch="ppc"
          echo -e "error not support $Archt" 
          EXIT 1
          ;;
          "powerpc64")
          Arch="ppc64"
          echo -e "error not support $Archt" 
          EXIT 1
          ;;
          *)
          echo -e "error not support $Archt if you can use offical release please issue a bug" 
          EXIT 1
          ;;
          esac
          wget https://github.com/AdguardTeam/AdGuardHome/releases/download/${latest_ver}/AdGuardHome_linux_${Arch}.tar.gz -O ./files/usr/bin/AdGuardHome/tmp/AdGuardHome.tar.gz
          tar -zxf "./files/usr/bin/AdGuardHome/tmp/AdGuardHome.tar.gz" -C "./files/usr/bin/AdGuardHome/tmp/"
          mv -f ./files/usr/bin/AdGuardHome/tmp/AdGuardHome/AdGuardHome ./files/usr/bin/AdGuardHome
          rm -rf ./files/usr/bin/AdGuardHome/tmp
      - name: 生成配置文件
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          make defconfig
          ./scripts/diffconfig.sh          
      - name: 剩余空间
        run:  |
          echo "======================="
          echo "空间使用情况:"
          echo "======================="
          df -h
          echo "======================="

      - name: test
        working-directory: ${{ env.WORKSPACE_ROOT_PATH }}
        run: |
          mkdir -p ./openwrt/bin/targets/x86/64/
          cp ./package/chen/lede/target/linux/generic/hack-5.10/952-net-conntrack-events-support-multiple-registrant.patch ./openwrt/bin/targets/x86/64/


      - name: 上传日志
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: x86-64-logs
          path: "${{ env.OPENWRT_ROOT_PATH }}/logs"

      - name: 准备 artifact
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          mkdir -p ./artifact/package
          mkdir -p ./artifact/buildinfo
          rm -rf $(find ./bin/targets/ -type d -name "packages")
          cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
          cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      - name: 生成 release tag
        working-directory: ${{ env.OPENWRT_ROOT_PATH }}
        run: |
          echo 编译于$(date +"%Y-%m-%d %H:%M") >> release.txt
          export RELEASE_NAME="OpenWrt-K V$(date +"%y.%m.%d-%H")"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

      - name: 上传 buildinfo
        uses: actions/upload-artifact@v3
        with:
          name: OpenWrt_buildinfo
          path: ${{ env.OPENWRT_ROOT_PATH }}/artifact/buildinfo/

      - name: 上传 package
        uses: actions/upload-artifact@v3
        with:
          name: OpenWrt_package
          path: ${{ env.OPENWRT_ROOT_PATH }}/artifact/package/

      - name: 上传 firmware
        uses: actions/upload-artifact@v3
        with:
          name: OpenWrt_firmware
          path: ${{ env.OPENWRT_ROOT_PATH }}/bin/targets/

      - name: 上传到 Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          name: ${{ env.RELEASE_NAME }}
          files: ${{ env.OPENWRT_ROOT_PATH }}/bin/targets/x86/64/*
          body_path: release.txt
      - name: Delete Older Releases
        uses: dev-drprasad/delete-older-releases@v0.2.1
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


          

      
